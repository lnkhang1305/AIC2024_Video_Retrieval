<html>
    <head>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <style>
          .overlay {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0, 0.9);
  overflow-x: hidden;
  transition: 0.5s;
}

.overlay .closebtn {
  position: absolute;
  top: 20px;
  right: 45px;
  font-size: 60px;
  color: white;
}

@media screen and (max-height: 450px) {
  .overlay a {font-size: 20px}
  .overlay .closebtn {
  font-size: 40px;
  top: 15px;
  right: 35px;
  }
}
        </style>
    </head>
    <body>
        <!--header-->
        <header class="text-gray-600 body-font">
            <div class="container mx-auto flex flex-wrap p-5 flex-col md:flex-row items-center">
              <a class="flex title-font font-medium items-center text-gray-900 mb-4 md:mb-0">
                <img class="w-16 h-16 rounded-full" src = "{{url_for('static', filename='assets/aiclogo2024.jpg')}}">
                <span class="ml-3 text-xl">HCMC AI Challenge 2024</span>
              </a>
              <nav class="md:ml-auto flex flex-wrap items-center text-base justify-center">
                <!-- <a class="mr-5 hover:text-gray-900">First Link</a>
                <a class="mr-5 hover:text-gray-900">Second Link</a>
                <a class="mr-5 hover:text-gray-900">Third Link</a>
                <a class="mr-5 hover:text-gray-900">Fourth Link</a> -->
              </nav>
              <a type="button" href="https://codalab.lisn.upsaclay.fr/competitions/20122" class="inline-flex items-center bg-gray-100 border-0 py-1 px-3 focus:outline-none hover:bg-gray-200 rounded text-base mt-4 md:mt-0">Đến trang chủ cuộc thi
                <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-4 h-4 ml-1" viewBox="0 0 24 24">
                  <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
              </a>
            </div>
          </header>
          <!--Main Content-->
          <main>
            <section class="text-gray-600 body-font relative">
                <div class="container px-5 py-24 mx-auto flex sm:flex-nowrap flex-wrap">
                    
                  <!--Input query-->
                  <div class="lg:w-1/3 md:w-1/2 bg-white flex flex-col md:ml-auto w-full md:py-8 mt-8 md:mt-0 m-8">
                    <h2 class="text-gray-900 text-lg mb-1 font-medium title-font">Câu truy vấn</h2>
                    <p class="leading-relaxed mb-5 text-gray-600">Vui lòng nhập một câu mô tả</p>
                    <div class="relative mb-4">
                      <label for="query_data" class="leading-7 text-sm text-gray-600">Câu truy vấn</label>
                      <textarea id="query_data" name="query_data" class="w-full bg-white rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 h-32 text-base outline-none text-gray-700 py-1 px-3 resize-none leading-6 transition-colors duration-200 ease-in-out"></textarea>
                    </div>
                    <div class="relative mb-4">
                            <label for="price-range" class="leading-7 text-sm text-gray-600">Số lượng kết quả truy vấn</label>
                            <div class="w-full flex">
                            <div class="w-3/5 mr-4">
                                <input type="range" id="quantity-range" class="w-full mr-4 accent-indigo-600" min="5" max="100" value="10" oninput="update_quantity(this.value)">
                                <div class="flex justify-between text-gray-500">
                                <span id="min_quantity">10</span>
                                <span id="max_quantity">100</span>
                                </div>
                            </div>
                                <div class="flex w-2/5 h-8">
                                <p class="content-center">Số lượng: </p>
                                <input type="text" id="retrieval_result_quantity" class="w-2/5 input input-bordered content-center ml-2 border-b-2 border-black" value="10" onchange="update_quantity(this.value)"/>
                                </div>
                            </div>
                    </div>
                    <button class="text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg" onclick="data_retrieval()">Truy vấn</button>
                  </div>

                  <!--Display query-->
                  <ul id="display_result" class="connected-sortable droppable-area1 lg:w-2/3 md:w-1/2 bg-gray-300 rounded-lg min-h-[32rem] max-h-screen h-fit overflow-y-scroll overflow-x-hidden p-10 flex-row items-end justify-start relative">

                    <li class="draggable-item flex" id="${element.ID}">
                      <div class="h-full w-10">
                          <input class="dark:border-white-400/20 dark:scale-100 transition-all duration-500 ease-in-out dark:hover:scale-110 dark:checked:scale-100 w-6 h-6" type="checkbox">
                      </div>
                      <div class="h_full">
                        <div draggable="true" class="result mb-8 flex lg:flex-row flex-col items-center sm:justify-start justify-center text-center sm:text-left">
                        <img draggable="false" alt="team" 
                        class="w-3/4 flex-shrink-0 rounded-lg max-w-128 max-h-72 object-cover object-center sm:mb-0 mb-4" 
                        src="https://dummyimage.com/1280x720"
                        onclick="openNav('1yHly8dYhIQ')">
                        <div draggable="false" class="flex-grow sm:pl-8 sm:w-full w-1/4">
                          <h2 class="title-font font-medium text-gray-900 mb-3">1</h2>
                          <h3 class="title-font font-medium text-gray-600 mb-3">Frame ID: ${element.Frame_id}</h3>
                          <h3 class="title-font font-medium text-gray-600 mb-3">Kết quả Q&A : ${element.qa}</h3>          
                        </div>
                      </div>
                      </div>
                    </li>

                    <li class="draggable-item">
                      <div draggable="true" class="result mb-8 flex lg:flex-row flex-col items-center sm:justify-start justify-center text-center sm:text-left">
                      <img draggable="false" alt="team" 
                      class="w-3/4 flex-shrink-0 rounded-lg max-w-128 max-h-72 object-cover object-center sm:mb-0 mb-4" 
                      src="https://dummyimage.com/1280x720"
                      onclick="openNav('2Z3pxUVnyx8')">
                      <div draggable="false" class="flex-grow sm:pl-8 sm:w-full w-1/4">
                        <h2 class="title-font font-medium text-gray-900 mb-3">2</h2>
                        <h3 class="title-font font-medium text-gray-600 mb-3">Frame ID: ${element.Frame_id}</h3>
                        <h3 class="title-font font-medium text-gray-600 mb-3">Kết quả Q&A : ${element.qa}</h3>          
                      </div>
                      </div>
                    </li>

                    <li class="draggable-item">
                      <div draggable="true" class="result mb-8 flex lg:flex-row flex-col items-center sm:justify-start justify-center text-center sm:text-left">
                      <img draggable="false" alt="team" 
                      class="w-3/4 flex-shrink-0 rounded-lg max-w-128 max-h-72 object-cover object-center sm:mb-0 mb-4" 
                      src="https://dummyimage.com/1280x720"
                      onclick="openNav('2Z3pxUVnyx8')">
                      <div draggable="false" class="flex-grow sm:pl-8 sm:w-full w-1/4">
                        <h2 class="title-font font-medium text-gray-900 mb-3">3</h2>
                        <h3 class="title-font font-medium text-gray-600 mb-3">Frame ID: ${element.Frame_id}</h3>
                        <h3 class="title-font font-medium text-gray-600 mb-3">Kết quả Q&A : ${element.qa}</h3>          
                      </div>
                      </div>
                    </li>

                  </div>

                </ul>
                <button id="abc" onclick="download_csv()">toCSV</button>
              </section>
          </main>
          <div id="myNav" class="overlay">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <div class="w-full h-full flex justify-center items-center">
              <div class="w-3/5 h-3/5 flex justify-center">
                <iframe id="youtube_video" class="aspect-video" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
              </div>
            </div>
          </div>

    </body>
    <script>
        function update_quantity(value) {
          document.getElementById("retrieval_result_quantity").value = value;
          document.getElementById("quantity-range").value = value;
        }
        function openNav(youtube_id) {
          $('#youtube_video').attr("src", "https://www.youtube.com/embed/"+youtube_id)
          $("#myNav").css('width' , "100%");
          $('body').css('overflow-y', 'hidden');
        }

        function closeNav() {
          $('#youtube_video').attr("src","")
          $("#myNav").css('width' , "0%");
          $('body').css('overflow-y', 'scroll');
        }
    </script>
    <script src="{{url_for('static', filename='js/to_csv.js')}}"></script>
    <script>
      function data_retrieval(){
        let query = $('#query_data').val();
        let k = $('#retrieval_result_quantity').val()
        // console.log(query, k)
        $.ajax({
                type : 'POST',
                url : "/video_retrieval",
                data: {"query":query, 'k': k},
                success: function(data, textStatus, jqXHR){
                  console.log(data)
                  receive_data = {}
                  for (key of data) {
                    parse_json = JSON.parse(key)
                    receive_data[parse_json.ID] = {
                      ID: parse_json.ID,
                      Video_info: parse_json.Video_info,
                      Image: parse_json.Image,
                      Video: parse_json.Video,
                      Frame_id: parse_json.Frame_id,
                      Youtube_id: parse_json.Youtube_id
                    };
                  }
                  console.log(receive_data)
                  localStorage.setItem("retrieval_data", JSON.stringify(receive_data));
                  // console.log(localStorage.getItem("retrieval_data"))
                  $('#display_result').empty();
                    data.forEach(ele => {
                      element = JSON.parse(ele)
                      console.log(element)
                      $('#display_result').append(`
                      <li class="draggable-item flex" id="${element.ID}">
                        <div class="h-full w-10">
                            <input class="dark:border-white-400/20 dark:scale-100 transition-all duration-500 ease-in-out dark:hover:scale-110 dark:checked:scale-100 w-6 h-6" type="checkbox">
                        </div>
                        <div class="h_full">
                          <div draggable="true" class="result mb-8 flex lg:flex-row flex-col items-center sm:justify-start justify-center text-center sm:text-left">
                          <img draggable="false" alt="team" 
                          class="w-3/4 flex-shrink-0 rounded-lg max-w-128 max-h-72 object-cover object-center sm:mb-0 mb-4" 
                          src="https://dummyimage.com/1280x720"
                          onclick="openNav('${element.Youtube_id}')">
                          <div draggable="false" class="flex-grow sm:pl-8 sm:w-full w-1/4">
                            <h2 class="title-font font-medium text-gray-900 mb-3">ID: ${element.ID}</h2>
                            <h3 class="title-font font-medium text-gray-600 mb-3">Frame ID: ${element.Frame_id}</h3>
                            <h3 class="title-font font-medium text-gray-600 mb-3">Video info : ${element.Video_info}</h3>    
                            <h3 class="title-font font-medium text-gray-600 mb-3">Thời điểm của frame : ${Math.floor(+(element.Frame_id)/ 25 / 60 )}:${Math.floor(+(element.Frame_id)/ 25 % 60)}</h3>           
                          </div>
                        </div>
                        </div>
                      </li>
                      `)
                    });
                    // $("#abcd").attr("src","data:image/png;base64,"+data)
                }
                });
              }
    </script>
    <script>
      function download_csv(){
        data_to_csv = []
        data_lst = JSON.parse(localStorage.getItem("retrieval_data"))
        $("#display_result").find("input:checkbox:checked").each(function(){
          data_to_csv.push(data_lst[$(this).parent().parent().attr('id')])
        })
        column_to_get = ['Video_info', 'Frame_id']
        exportJSONToCSV(data_to_csv, column_to_get)
        // console.log(JSON.parse(localStorage.getItem("retrieval_data")))
      }
    </script>
    <script>
      $( init );
function init() {
  $( ".droppable-area1" ).sortable({
      connectWith: ".connected-sortable",
      stack: '.connected-sortable ul'
    }).disableSelection();
}
    </script>

</html>